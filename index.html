
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Consent Flow</title>
  <meta name="description" content="Two-step consent flow with OneTrust prefill."/>

  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --border: #e5e7eb;
      --input-bg: #f9fafb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: flex; justify-content: center; align-items: flex-start; padding: 40px 16px;
    }
    .card {
      width: 100%; max-width: 560px; background: var(--card);
      border-radius: 16px; padding: 28px; box-shadow: 0 12px 32px rgba(0,0,0,0.08);
      animation: fadeIn .3s ease;
    }
    h1, h2 { margin: 0 0 8px; font-weight: 700; }
    p.sub { margin: 0 0 20px; color: var(--muted); }
    label { display: block; margin: 14px 0 6px; font-weight: 600; }
    input, select {
      width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--input-bg); font-size: 1rem; transition: border-color .2s, background .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    .actions { margin-top: 18px; display: flex; gap: 12px; }
    button {
      flex: 1; padding: 14px; border: none; border-radius: 10px; cursor: pointer;
      font-weight: 700; font-size: 1rem;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .hidden { display: none; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
    #ot-container { margin-top: 16px; min-height: 64px; }
  </style>
</head>
<body>

  <!-- STEP 1 -->
  <section id="step1" class="card" aria-label="Step 1: Your details">
    <h2>Your Details</h2>
    <p class="sub">Tell us who you are. On the next step, you’ll manage your consent preferences.</p>

    <div class="row">
      <div>
        <label for="firstName">First name</label>
        <input id="firstName" type="text" placeholder="e.g. Álvaro"/>
      </div>

      <div>
        <label for="email">Email *</label>
        <input id="email" type="email" placeholder="alvaro@example.com" required/>
      </div>

      <div>
        <label for="country">Country/Region</label>
        <select id="country">
          <option value="">Select…</option>
          <option value="ES">Spain</option>
          <option value="PT">Portugal</option>
          <option value="FR">France</option>
          <option value="DE">Germany</option>
          <option value="UK">United Kingdom</option>
          <option value="US">United States</option>
          <option value="MX">Mexico</option>
          <option value="BR">Brazil</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="nextBtn" class="btn-primary">Next</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section id="step2" class="card hidden" aria-label="Step 2: Consent form">
    <h2>Manage Your Consent</h2>
    <p class="sub">Review and update your consent preferences below.</p>

    <!-- OneTrust web form mounts here -->
    <div id="ot-container" aria-label="OneTrust web form container"></div>

    <div class="actions">
      <button id="backBtn" class="btn-ghost" type="button">Back</button>
    </div>
  </section>

  <!-- OneTrust Form Stub -->
  <script
    src="https://privacyportaltrial.onetrust.com/consent-embedded-forms/consent-receipt-scripts/OtFormStub.js"
    data-id="0ceb7c0c-d27e-43c6-9c9c-877694285648"
    worker="https://consent-api.onetrust.com"
  ></script>

  <script>
    // --- Robust helpers ---
    function waitFor(checkFn, { interval = 150, timeout = 10000 } = {}) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        const timer = setInterval(() => {
          if (checkFn()) { clearInterval(timer); resolve(true); }
          else if (Date.now() - start > timeout) { clearInterval(timer); reject(new Error('waitFor timed out')); }
        }, interval);
      });
    }

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');

    backBtn.addEventListener('click', () => {
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
      // Optional: clear OneTrust container on back
      // document.getElementById('ot-container').innerHTML = '';
    });

    nextBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) {
        alert('Please enter your email to continue.');
        return;
      }

      // Transition UI first
      step1.classList.add('hidden');
      step2.classList.remove('hidden');

      try {
        // 1) Ensure the stub queue exists
        await waitFor(() => typeof window.OtConsentStub !== 'undefined');

        // 2) Enqueue init + prefill after stub is ready
        window.OtConsentStub = window.OtConsentStub || [];
        window.OtConsentStub.push(async function (api) {
          // 2a) Mount into our container
          api.init({ container: 'ot-container' });

          // 2b) Wait until OneTrust web form library is available
          await waitFor(() => window.OneTrust && OneTrust.webform && typeof OneTrust.webform.preFill === 'function');

          // 2c) (Optional but robust) Wait for form elements to render
          await waitFor(() => !!document.querySelector('#ot-container form, #ot-container [data-ot-form]'));

          // 3) Pre-fill using the exact action/syntax you requested
          // NOTE: Field labels MUST match OneTrust default-language labels.
          OneTrust.webform.preFill({
            "Email": email,
            // Include this if you want to pass an auxiliary free text value:
            // "Free text input": "free text content"
          }, "c9322d35-cb63-4974-b65a-5d415f818a05");
          console.debug('[OneTrust] preFill executed with email:', email);
        });
      } catch (err) {
        console.error('Error initializing OneTrust or prefilling:', err);
      }
    });
  </script>
</body>
</html>
