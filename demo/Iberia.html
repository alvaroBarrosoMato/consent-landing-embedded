<!-- Description: Single-file demo page with an Iberia/Stripe-style checkout; Consent is hidden in a second tab next to payment and loads the OneTrust UCPM Embedded Web Form manually into a container under the price breakdown. -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Iberia-branded demo with simulated payment UI + OneTrust UCPM Embedded Web Form Collection Point (manual load in a side tab)." />
  <meta name="theme-color" content="#D71920" />
  <title>Iberia | Simulated Checkout + Consent (OneTrust UCPM)</title>

  <!-- OneTrust Embedded Web Form SDK integration script (from Collection Point ‚Üí Integrations tab). Must be in <head>. -->
  <script
      src="https://privacyportaltrial.onetrust.com/consent-embedded-forms/consent-receipt-scripts/OtFormStub.js"
      data-id="0ceb7c0c-d27e-43c6-9c9c-877694285648"
      worker="https://consent-api.onetrust.com">
  </script>

  <style>
    :root{
      --ib-red:#D71920;
      --ib-red-2:#B5141A;
      --ib-yellow:#FFC72C;
      --ink:#101828;
      --muted:#475467;
      --bg:#FFF7EB;
      --card:#FFFFFF;
      --line:#E4E7EC;
      --shadow: 0 18px 45px rgba(16,24,40,.10);
      --shadow-soft: 0 10px 30px rgba(16,24,40,.08);
      --radius: 18px;
      --radius-sm: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --stripe:#635BFF;
      --stripe-2:#4F46E5;
      --stripe-3:#1D4ED8;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--ink);
      background:
        radial-gradient(1200px 500px at 10% 0%, rgba(255,199,44,.55) 0%, rgba(255,199,44,0) 65%),
        radial-gradient(1000px 600px at 90% 20%, rgba(215,25,32,.25) 0%, rgba(215,25,32,0) 70%),
        linear-gradient(180deg, #FFF2DE 0%, var(--bg) 40%, #FFFFFF 100%);
      overflow-x:hidden;
    }

    .wrap{ max-width: 1120px; margin: 0 auto; padding: 28px 16px 34px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 10px 4px 18px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width: 240px; }
    .logoMark{
      width: 46px; height: 46px; border-radius: 14px;
      background: conic-gradient(from 240deg, var(--ib-red), var(--ib-red), var(--ib-yellow), var(--ib-yellow), var(--ib-red));
      box-shadow: 0 10px 24px rgba(215,25,32,.25);
      position:relative; isolation:isolate;
    }
    .logoMark:after{ content:""; position:absolute; inset:10px; border-radius: 10px; background: rgba(255,255,255,.18); transform: rotate(12deg); mix-blend-mode: overlay; }

    .brandText{ display:flex; flex-direction:column; line-height:1.1; }
    .brandText .title{ font-size: 18px; font-weight: 900; letter-spacing: .16em; text-transform: uppercase; }
    .brandText .subtitle{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 12px; border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(228,231,236,.9);
      box-shadow: 0 8px 22px rgba(16,24,40,.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size: 12px; color: var(--muted);
      white-space: nowrap;
    }
    .dot{ width:9px;height:9px;border-radius:99px; background: var(--ib-red); box-shadow: 0 0 0 4px rgba(215,25,32,.15); }

    /* Main card */
    .card{
      background: var(--card);
      border: 1px solid rgba(228,231,236,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHeader{
      padding: 18px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(228,231,236,.8);
      background: linear-gradient(180deg, rgba(255,255,255,.95) 0%, rgba(255,255,255,.85) 100%);
    }

    .cardTitle{ display:flex; flex-direction:column; gap:4px; }
    .cardTitle h2{ margin:0; font-size: 16px; font-weight: 800; letter-spacing: .2px; }
    .cardTitle p{ margin:0; font-size: 12px; color: var(--muted); }

    .cardBody{ padding: 18px; }

    /* Two-column checkout layout */
    .checkoutGrid{ display:grid; grid-template-columns: 1.15fr .85fr; gap: 18px; align-items:start; }

    /* Stripe simulated form shell */
    .stripeShell{ border-radius: var(--radius-sm); border: 1px solid rgba(228,231,236,.95); box-shadow: var(--shadow-soft); overflow:hidden; background:#fff; }
    .stripeTop{ padding: 14px 14px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(135deg, rgba(215,25,32,.10) 0%, rgba(255,199,44,.18) 55%, rgba(255,255,255,1) 100%);
      border-bottom: 1px solid rgba(228,231,236,.9);
    }

    .stripeBadge{ display:flex; align-items:center; gap:10px; font-weight: 800; font-size: 12px; color: var(--ink); letter-spacing:.06em; text-transform: uppercase; }
    .stripeBadge .mini{ width:28px;height:28px;border-radius:10px; background: linear-gradient(135deg, var(--stripe) 0%, var(--stripe-2) 65%, var(--stripe-3) 100%); box-shadow: 0 12px 24px rgba(79,70,229,.25); position:relative; }
    .stripeBadge .mini:after{ content:""; position:absolute; inset:7px; border-radius:7px; background: rgba(255,255,255,.18); transform: rotate(8deg); mix-blend-mode: overlay; }

    .secureHint{ font-size: 12px; color: var(--muted); display:flex; align-items:center; gap:8px; white-space:nowrap; }

    .lock{ width:16px;height:16px; display:inline-block; background: conic-gradient(from 120deg, rgba(16,24,40,.18), rgba(16,24,40,.45), rgba(16,24,40,.18));
      -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-7-2a2 2 0 0 1 4 0v2h-4V6Zm7 14H7V10h10v10Z"/></svg>') center/contain no-repeat;
      mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-7-2a2 2 0 0 1 4 0v2h-4V6Zm7 14H7V10h10v10Z"/></svg>') center/contain no-repeat;
    }

    .stripeForm{ padding: 14px; display:grid; gap: 12px; }
    .fieldGrid{ display:grid; grid-template-columns: 1fr 140px 120px; gap: 10px; }
    .labelRow{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom: 4px; }

    label{ font-size: 12px; font-weight: 700; color: var(--ink); letter-spacing:.2px; }
    .hint{ font-size: 12px; color: var(--muted); }

    input{ width:100%; padding: 12px 12px; border-radius: 12px; border: 1px solid rgba(228,231,236,.95); outline:none; font-size: 14px; background:#fff; transition: border-color .15s ease, box-shadow .15s ease; }
    input:focus{ border-color: rgba(99,91,255,.55); box-shadow: 0 0 0 4px rgba(99,91,255,.14); }
    input::placeholder{ color: rgba(71,84,103,.55); }

    .payRow{ display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-top: 2px; flex-wrap: wrap; }

    .btn{ appearance:none; border:none; cursor:pointer; border-radius: 999px; padding: 12px 16px; font-weight: 900; letter-spacing:.2px; transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease; display:inline-flex; align-items:center; gap:10px; user-select:none; }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{ background: linear-gradient(135deg, var(--ib-red) 0%, #F04438 45%, var(--ib-yellow) 110%); color:#fff; box-shadow: 0 16px 34px rgba(215,25,32,.22); }
    .btnPrimary:hover{ box-shadow: 0 18px 40px rgba(215,25,32,.28); }
    .btnGhost{ background: rgba(16,24,40,.04); color: var(--ink); }
    .btnGhost:hover{ background: rgba(16,24,40,.06); }

    .msg{ border-radius: 14px; padding: 12px 12px; font-size: 12px; border: 1px solid rgba(228,231,236,.95); background: rgba(16,24,40,.02); color: var(--muted); display:flex; gap:10px; align-items:flex-start; }
    .msg strong{ color: var(--ink); }
    .msg.ok{ border-color: rgba(5,150,105,.25); background: rgba(5,150,105,.08); color: #065F46; }
    .msg.err{ border-color: rgba(240,68,56,.28); background: rgba(240,68,56,.08); color: #7A271A; }

    .icon{ width:18px;height:18px;border-radius: 6px; background: rgba(71,84,103,.12); flex: 0 0 auto; position:relative; }
    .icon:after{ content:""; position:absolute; inset:4px; border-radius:5px; background: rgba(71,84,103,.24); }
    .icon.ok{ background: rgba(5,150,105,.18); }
    .icon.ok:after{ background: rgba(5,150,105,.45); }
    .icon.err{ background: rgba(240,68,56,.18); }
    .icon.err:after{ background: rgba(240,68,56,.45); }

    /* Right panel (tabs) */
    .sidePanel{ border-radius: var(--radius-sm); border: 1px solid rgba(228,231,236,.95); background: rgba(255,255,255,.92); box-shadow: var(--shadow-soft); overflow:hidden; }

    .tabs{
      display:flex;
      gap:6px;
      padding: 10px;
      border-bottom: 1px solid rgba(228,231,236,.9);
      background: linear-gradient(180deg, rgba(255,255,255,.95) 0%, rgba(255,255,255,.85) 100%);
    }
    .tabBtn{
      flex: 1 1 auto;
      border-radius: 999px;
      border: 1px solid rgba(228,231,236,.95);
      background: rgba(16,24,40,.03);
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: rgba(16,24,40,.76);
      cursor:pointer;
      transition: background .15s ease, box-shadow .15s ease, transform .12s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .tabBtn:active{ transform: translateY(1px); }
    .tabBtn[aria-selected="true"]{
      background: rgba(255,199,44,.28);
      border-color: rgba(255,199,44,.55);
      color: rgba(16,24,40,.9);
      box-shadow: 0 10px 24px rgba(255,199,44,.14);
    }

    .panel{ display:none; padding: 14px; }
    .panel.active{ display:block; }

    .orderLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid rgba(228,231,236,.8); font-size: 13px; color: var(--muted); }
    .orderLine:last-child{ border-bottom:none; }
    .orderLine strong{ color: var(--ink); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: rgba(16,24,40,.78); line-height: 1.45; word-break: break-word; white-space: pre-wrap; }

    .divider{ height:1px; background: rgba(228,231,236,.9); margin: 12px 0; }

    .otContainerWrap{ border-radius: 14px; border: 1px solid rgba(228,231,236,.95); overflow:hidden; background:#fff; }
    .otContainerHeader{ padding: 12px; border-bottom: 1px solid rgba(228,231,236,.9); display:flex; align-items:center; justify-content:space-between; gap:10px; background: linear-gradient(135deg, rgba(255,199,44,.22) 0%, rgba(255,255,255,1) 55%, rgba(215,25,32,.08) 100%); }
    .otContainerHeader .left{ display:flex; flex-direction:column; gap:2px; }
    .otContainerHeader .kicker{ font-size: 12px; font-weight: 900; letter-spacing: .14em; text-transform: uppercase; color: var(--ib-red-2); }
    .otContainerHeader .desc{ font-size: 12px; color: var(--muted); }

    .statusBox{ margin-top: 12px; border-radius: 14px; border: 1px solid rgba(228,231,236,.95); background: rgba(255,255,255,.8); padding: 12px; }
    .statusHead{ display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
    .statusHead .label{ font-weight: 900; font-size: 12px; letter-spacing: .08em; text-transform: uppercase; color: var(--muted); }
    .chip{ font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(228,231,236,.95); background: rgba(16,24,40,.02); color: var(--muted); display:inline-flex; align-items:center; gap:8px; white-space:nowrap; }
    .tinyDot{ width:8px;height:8px;border-radius:99px;background: rgba(71,84,103,.55); }
    .chip.ok .tinyDot{ background: rgba(5,150,105,.85); }
    .chip.err .tinyDot{ background: rgba(240,68,56,.9); }

    footer{ margin-top: 20px; padding: 18px 0 10px; text-align:center; color: var(--muted); font-size: 12px; }

    @media (max-width: 920px){
      .checkoutGrid{ grid-template-columns: 1fr; }
      .fieldGrid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; align-items:flex-start; }
      .pill{ align-self:flex-start; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; scroll-behavior:auto !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand" aria-label="Iberia demo header">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="brandText">
          <div class="title">IBERIA</div>
          <div class="subtitle">Checkout demo ¬∑ Consent in side tab ¬∑ Load Method: <strong id="loadMethodLabel">Manual</strong></div>
        </div>
      </div>
      <div class="pill" role="status" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span id="headerStatusText">Ready ‚Äî open the ‚ÄúConsent‚Äù tab to load the form manually.</span>
      </div>
    </header>

    <section class="card" aria-label="Checkout and consent">
      <div class="cardHeader">
        <div class="cardTitle">
          <h2>Checkout (simulated) + Consent</h2>
          <p>Consent is hidden in a second tab next to payment. The OneTrust form renders under the price breakdown in the right panel.</p>
        </div>
        <div class="pill" aria-label="Manual load pill">
          <span class="dot" style="background:var(--stripe); box-shadow: 0 0 0 4px rgba(99,91,255,.14)" aria-hidden="true"></span>
          Manual InstallCP
        </div>
      </div>

      <div class="cardBody">
        <div class="checkoutGrid">
          <!-- Left: simulated card payment -->
          <div class="stripeShell" aria-label="Simulated Stripe card form">
            <div class="stripeTop">
              <div class="stripeBadge">
                <span class="mini" aria-hidden="true"></span>
                <span>Card payment</span>
              </div>
              <div class="secureHint">
                <span class="lock" aria-hidden="true"></span>
                <span>Secure checkout (simulated)</span>
              </div>
            </div>

            <form class="stripeForm" id="fakePaymentForm" autocomplete="off" novalidate>
              <div>
                <div class="labelRow">
                  <label for="cardholder">Cardholder name</label>
                  <span class="hint">As printed on card</span>
                </div>
                <input id="cardholder" name="cardholder" type="text" inputmode="text" autocomplete="off" value="Alvaro Barroso" />
              </div>

              <div>
                <div class="labelRow">
                  <label for="cardnumber">Card number</label>
                  <span class="hint">Test number</span>
                </div>
                <input id="cardnumber" name="cardnumber" type="text" inputmode="numeric" autocomplete="off" maxlength="19" value="4242 4242 4242 4242" />
              </div>

              <div class="fieldGrid">
                <div>
                  <div class="labelRow">
                    <label for="email">Email receipt</label>
                    <span class="hint">Optional</span>
                  </div>
                  <input id="email" name="email" type="email" inputmode="email" autocomplete="off" value="alvaro@example.com" />
                </div>
                <div>
                  <div class="labelRow">
                    <label for="exp">Expiry</label>
                    <span class="hint">MM/YY</span>
                  </div>
                  <input id="exp" name="exp" type="text" inputmode="numeric" maxlength="5" autocomplete="off" value="12/34" />
                </div>
                <div>
                  <div class="labelRow">
                    <label for="cvc">CVC</label>
                    <span class="hint">3 digits</span>
                  </div>
                  <input id="cvc" name="cvc" type="password" inputmode="numeric" maxlength="4" autocomplete="off" value="123" />
                </div>
              </div>

              <div class="payRow">
                <button class="btn btnGhost" type="button" id="resetPaymentBtn">Reset</button>
                <button class="btn btnPrimary" type="submit" id="payBtn">
                  <span aria-hidden="true">‚úàÔ∏è</span>
                  <span>Pay ‚Ç¨199.00</span>
                </button>
              </div>

              <div id="paymentMsg" class="msg" role="status" aria-live="polite">
                <span class="icon" aria-hidden="true"></span>
                <div>
                  <strong>Preloaded demo values.</strong> Click <span class="mono">Pay</span> to simulate validation, then open <span class="mono">Consent</span> tab on the right.
                  <div class="hint" style="margin-top:4px;">No data is stored; this is a visual simulation.</div>
                </div>
              </div>
            </form>
          </div>

          <!-- Right: tabs (Summary / Consent) -->
          <aside class="sidePanel" aria-label="Side panel tabs">
            <div class="tabs" role="tablist" aria-label="Payment and consent tabs">
              <button class="tabBtn" id="tabSummary" role="tab" aria-selected="true" aria-controls="panelSummary">
                <span aria-hidden="true">üßæ</span> Summary
              </button>
              <button class="tabBtn" id="tabConsent" role="tab" aria-selected="false" aria-controls="panelConsent">
                <span aria-hidden="true">üîí</span> Consent
              </button>
            </div>

            <!-- Panel: Summary -->
            <div class="panel active" id="panelSummary" role="tabpanel" aria-labelledby="tabSummary">
              <div class="orderLine"><span>Flight</span><strong>MAD ‚Üí BCN</strong></div>
              <div class="orderLine"><span>Fare</span><span class="amount">‚Ç¨179.00</span></div>
              <div class="orderLine"><span>Taxes</span><span class="amount">‚Ç¨20.00</span></div>
              <div class="orderLine"><span><strong>Total</strong></span><span class="amount">‚Ç¨199.00</span></div>
              <div class="divider"></div>
              <div class="hint">
                Open the <strong>Consent</strong> tab to view the OneTrust form under this breakdown.
              </div>
            </div>

            <!-- Panel: Consent (price breakdown + OT container underneath) -->
            <div class="panel" id="panelConsent" role="tabpanel" aria-labelledby="tabConsent">
              <div class="orderLine"><span>Flight</span><strong>MAD ‚Üí BCN</strong></div>
              <div class="orderLine"><span>Fare</span><span class="amount">‚Ç¨179.00</span></div>
              <div class="orderLine"><span>Taxes</span><span class="amount">‚Ç¨20.00</span></div>
              <div class="orderLine"><span><strong>Total</strong></span><span class="amount">‚Ç¨199.00</span></div>

              <div class="divider"></div>

              <div class="otContainerWrap" aria-label="OneTrust container under breakdown">
                <div class="otContainerHeader">
                  <div class="left">
                    <div class="kicker">OneTrust Embedded Web Form</div>
                    <div class="desc">CP: <span class="mono" id="cpLabel"></span> ¬∑ Container: <span class="mono">#ot-container</span></div>
                  </div>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn btnGhost" type="button" id="loadOtBtn" aria-label="Load OneTrust consent form">
                      <span aria-hidden="true">‚¨áÔ∏è</span>
                      <span>Load</span>
                    </button>
                  </div>
                </div>

                <!-- TARGET_CONTAINER_ID (must match config.containerId) -->
                <div id="ot-container" aria-label="OneTrust web form container" style="padding:12px;"></div>
              </div>

              <div class="statusBox" aria-label="Debug and status">
                <div class="statusHead">
                  <div class="label">Debug / Status</div>
                  <div class="chip" id="statusChip">
                    <span class="tinyDot" aria-hidden="true"></span>
                    <span id="statusChipText">Ready</span>
                  </div>
                </div>
                <div class="mono" id="statusLog">Booting‚Ä¶</div>
              </div>

              <div class="statusBox" aria-label="Prefill helper">
                <div class="statusHead">
                  <div class="label">Prefill (query parameter) helper</div>
                  <div class="chip" id="prefillChip">
                    <span class="tinyDot" aria-hidden="true"></span>
                    <span id="prefillChipText">Prefill mode: None</span>
                  </div>
                </div>
                <div class="mono" id="prefillLog">
Prefill is disabled for this demo.
If you enable prefilling in OneTrust, pass query parameters where each key matches the ‚ÄúForm Field Label‚Äù.
Example: ?Email=name%40domain.com&Country=Spain
Note: values must be URL-encoded (e.g. ‚Äú+‚Äù ‚Üí ‚Äú%2B‚Äù) and multiple fields separated by ‚Äú&‚Äù.
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <footer>Created by Alvaro Barroso in Madrid, Espa√±ita.</footer>
  </div>

  <script>
    "use strict";

    /**
     * Manual load uses InstallCP for embedded web forms. ÓàÄciteÓàÇturn7search62ÓàÅ
     * Events supported: OnetrustFormLoaded, OneTrustWebFormSubmitted. ÓàÄciteÓàÇturn7search62ÓàÅ
     */
    const CONFIG = {
      collectionPointId: "c9322d35-cb63-4974-b65a-5d415f818a05",
      loadMethod: "Manual",
      containerId: "ot-container",
      optionalRedirectUrl: "",
      prefillMode: "None"
    };

    const el = (id) => document.getElementById(id);

    const ui = {
      headerStatusText: el("headerStatusText"),
      loadMethodLabel: el("loadMethodLabel"),
      cpLabel: el("cpLabel"),
      statusChip: el("statusChip"),
      statusChipText: el("statusChipText"),
      statusLog: el("statusLog"),
      prefillChip: el("prefillChip"),
      prefillChipText: el("prefillChipText"),
      prefillLog: el("prefillLog"),
      loadOtBtn: el("loadOtBtn"),
      tabSummary: el("tabSummary"),
      tabConsent: el("tabConsent"),
      panelSummary: el("panelSummary"),
      panelConsent: el("panelConsent"),
    };

    function safeStringify(obj) {
      try { return JSON.stringify(obj, (k, v) => (typeof v === "bigint" ? v.toString() : v), 2); }
      catch (e) { return String(obj); }
    }

    function setChip(state /* ok|err|neutral */, text) {
      const chip = ui.statusChip;
      chip.classList.remove("ok", "err");
      if (state === "ok") chip.classList.add("ok");
      if (state === "err") chip.classList.add("err");
      ui.statusChipText.textContent = text;
    }

    function logStatus(message, data) {
      const stamp = new Date().toLocaleTimeString();
      const line = `[${stamp}] ${message}`;
      const payload = (data !== undefined) ? `\n${safeStringify(data)}` : "";
      ui.statusLog.textContent = (ui.statusLog.textContent ? (ui.statusLog.textContent + "\n") : "") + line + payload;
      const lines = ui.statusLog.textContent.split("\n");
      if (lines.length > 140) ui.statusLog.textContent = lines.slice(lines.length - 140).join("\n");
    }

    function updateHeaderStatus(text, tone /* ok|warn|neutral */) {
      ui.headerStatusText.textContent = text;
      const dot = document.querySelector("header .pill .dot");
      if (!dot) return;
      if (tone === "ok") {
        dot.style.background = "rgba(5,150,105,.95)";
        dot.style.boxShadow = "0 0 0 4px rgba(5,150,105,.18)";
      } else if (tone === "warn") {
        dot.style.background = "rgba(255,199,44,.95)";
        dot.style.boxShadow = "0 0 0 4px rgba(255,199,44,.22)";
      } else {
        dot.style.background = "var(--ib-red)";
        dot.style.boxShadow = "0 0 0 4px rgba(215,25,32,.15)";
      }
    }

    // ---------- Tabs ----------
    function setActiveTab(which /* summary|consent */) {
      const isConsent = which === "consent";
      ui.tabSummary.setAttribute("aria-selected", String(!isConsent));
      ui.tabConsent.setAttribute("aria-selected", String(isConsent));
      ui.panelSummary.classList.toggle("active", !isConsent);
      ui.panelConsent.classList.toggle("active", isConsent);

      if (isConsent) {
        // This user action (opening the Consent tab) triggers manual load.
        installCollectionPointManual("Consent tab opened");
      }
    }

    ui.tabSummary.addEventListener("click", () => setActiveTab("summary"));
    ui.tabConsent.addEventListener("click", () => setActiveTab("consent"));

    // ---------- OneTrust manual loading (InstallCP) ----------
    let installAttempted = false;

    function canUseOneTrustWebformInstall() {
      return Boolean(window.OneTrust && window.OneTrust.webform && typeof window.OneTrust.webform.InstallCP === "function");
    }

    function canUseOtSdkQueue() {
      return typeof window.OtSdk === "function";
    }

    function installCollectionPointManual(triggerSource) {
      if (CONFIG.loadMethod !== "Manual") return;
      if (installAttempted) {
        logStatus(`InstallCP skipped (already attempted). Trigger: ${triggerSource}`);
        return;
      }

      const container = document.getElementById(CONFIG.containerId);
      if (!container) {
        const msg = `TARGET_CONTAINER_ID not found in DOM: #${CONFIG.containerId}`;
        console.error(msg);
        setChip("err", "Container missing");
        logStatus(msg);
        updateHeaderStatus("Container missing ‚Äî form cannot render.", "warn");
        return;
      }

      installAttempted = true;
      setChip("neutral", "Installing‚Ä¶");
      updateHeaderStatus("Installing consent form‚Ä¶", "warn");
      logStatus(`Manual load triggered (${triggerSource}). Attempting InstallCP for CP_ID=${CONFIG.collectionPointId}`);

      try {
        if (canUseOneTrustWebformInstall()) {
          // OneTrust.webform.InstallCP("collection point id", callback)
          window.OneTrust.webform.InstallCP(CONFIG.collectionPointId, function (result) {
            console.log("InstallCP callback result:", result);
            logStatus("InstallCP callback returned:", result);
            if (result === true) {
              setChip("ok", "InstallCP ok");
              updateHeaderStatus("Consent form loaded.", "ok");
            } else {
              setChip("err", "InstallCP failed");
              updateHeaderStatus("InstallCP failed ‚Äî check CP config / script.", "warn");
            }
          });
          return;
        }

        if (canUseOtSdkQueue()) {
          // OtSdk('consent','InstallCP','collection point id', callback)
          window.OtSdk('consent', 'InstallCP', CONFIG.collectionPointId, function (result) {
            console.log("OtSdk InstallCP callback result:", result);
            logStatus("OtSdk InstallCP callback returned:", result);
            if (result === true) {
              setChip("ok", "InstallCP ok");
              updateHeaderStatus("Consent form loaded.", "ok");
            } else {
              setChip("err", "InstallCP failed");
              updateHeaderStatus("InstallCP failed ‚Äî check CP config / script.", "warn");
            }
          });
          return;
        }

        const msg = "OneTrust SDK not available yet ‚Äî cannot call InstallCP. Verify the integration script in <head>.";
        console.error(msg);
        setChip("err", "SDK missing");
        logStatus(msg);
        updateHeaderStatus("OneTrust SDK not detected ‚Äî cannot load form.", "warn");
      } catch (e) {
        console.error("InstallCP error:", e);
        setChip("err", "InstallCP error");
        logStatus("InstallCP threw an error:", { message: e.message, stack: e.stack });
        updateHeaderStatus("InstallCP error ‚Äî see console.", "warn");
      }
    }

    // explicit load button inside Consent tab
    ui.loadOtBtn.addEventListener("click", () => installCollectionPointManual("Load button"));

    // ---------- Required Events ----------
    window.addEventListener("OnetrustFormLoaded", (event) => {
      console.log("OnetrustFormLoaded event triggered", event.detail);
      setChip("ok", "Form loaded");
      updateHeaderStatus("OneTrust form loaded successfully.", "ok");
      logStatus("OnetrustFormLoaded received. Details:", event.detail);
    });

    window.addEventListener("OneTrustWebFormSubmitted", (event) => {
      console.log("OneTrustWebFormSubmitted event triggered", event.detail);
      setChip("ok", "Form submitted");
      updateHeaderStatus("Consent form submitted (payload logged to console).", "ok");
      logStatus("OneTrustWebFormSubmitted received. Consent receipt payload (event.detail):", event.detail);
    });

    // ---------- Prefill helper (query params) ----------
    function renderPrefillDebug() {
      ui.prefillChipText.textContent = `Prefill mode: ${CONFIG.prefillMode}`;
      ui.prefillChip.classList.remove("ok", "err");
      ui.prefillChip.classList.add("ok");
    }

    // ---------- Payment simulation ----------
    const payment = {
      form: el("fakePaymentForm"),
      cardholder: el("cardholder"),
      cardnumber: el("cardnumber"),
      email: el("email"),
      exp: el("exp"),
      cvc: el("cvc"),
      resetBtn: el("resetPaymentBtn"),
      msg: el("paymentMsg")
    };

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;",
        "'":"&#39;"
      }[c]));
    }

    function setPaymentMessage(type /* ok|err|neutral */, title, body) {
      payment.msg.classList.remove("ok", "err");
      const icon = payment.msg.querySelector(".icon");
      icon.classList.remove("ok", "err");
      if (type === "ok") { payment.msg.classList.add("ok"); icon.classList.add("ok"); }
      if (type === "err") { payment.msg.classList.add("err"); icon.classList.add("err"); }
      payment.msg.querySelector("div").innerHTML =
        `<strong>${escapeHtml(title)}</strong><div class="hint" style="margin-top:4px;">${escapeHtml(body)}</div>`;
    }

    function normalizeCardNumber(value) { return value.replace(/\D/g, "").slice(0, 19); }
    function formatCardNumber(value) { const digits = normalizeCardNumber(value); return digits.replace(/(.{4})/g, "$1 ").trim(); }

    function luhnCheck(numStr) {
      const digits = numStr.replace(/\s+/g, "");
      if (!digits || digits.length < 12) return false;
      let sum = 0, alt = false;
      for (let i = digits.length - 1; i >= 0; i--) {
        let n = parseInt(digits[i], 10);
        if (Number.isNaN(n)) return false;
        if (alt) { n *= 2; if (n > 9) n -= 9; }
        sum += n;
        alt = !alt;
      }
      return sum % 10 === 0;
    }

    function normalizeExp(value) {
      const digits = value.replace(/\D/g, "").slice(0, 4);
      if (digits.length <= 2) return digits;
      return digits.slice(0,2) + "/" + digits.slice(2,4);
    }

    function validExp(mmYY) {
      const m = mmYY.match(/^(\d{2})\/(\d{2})$/);
      if (!m) return false;
      const mm = parseInt(m[1], 10);
      const yy = parseInt(m[2], 10);
      if (mm < 1 || mm > 12) return false;
      return yy >= 0 && yy <= 99;
    }

    function validCvc(v) { return /^\d{3,4}$/.test(v); }

    function simulatePayment() {
      const number = payment.cardnumber.value.trim();
      const exp = payment.exp.value.trim();
      const cvc = payment.cvc.value.trim();

      if (!luhnCheck(number)) {
        setPaymentMessage("err", "Payment failed", "Card number did not pass validation (Luhn). Try 4242 4242 4242 4242.");
        return false;
      }
      if (!validExp(exp)) {
        setPaymentMessage("err", "Payment failed", "Expiry must be in MM/YY format and a valid month.");
        return false;
      }
      if (!validCvc(cvc)) {
        setPaymentMessage("err", "Payment failed", "CVC must be 3‚Äì4 digits.");
        return false;
      }

      setPaymentMessage("ok", "Payment authorized (simulated)", "Validation passed. Open the Consent tab to load the consent form.");
      return true;
    }

    payment.cardnumber.addEventListener("input", (e) => { e.target.value = formatCardNumber(e.target.value); });
    payment.exp.addEventListener("input", (e) => { e.target.value = normalizeExp(e.target.value); });
    payment.cvc.addEventListener("input", (e) => { e.target.value = e.target.value.replace(/\D/g, "").slice(0, 4); });

    payment.resetBtn.addEventListener("click", () => {
      payment.form.reset();
      payment.cardholder.value = "Alvaro Barroso";
      payment.cardnumber.value = "4242 4242 4242 4242";
      payment.email.value = "alvaro@example.com";
      payment.exp.value = "12/34";
      payment.cvc.value = "123";
      setPaymentMessage("neutral", "Demo defaults restored", "You can now simulate payment and open the Consent tab.");
    });

    payment.form.addEventListener("submit", (e) => {
      e.preventDefault();
      simulatePayment();
    });

    // ---------- Boot ----------
    (function boot() {
      ui.loadMethodLabel.textContent = CONFIG.loadMethod;
      ui.cpLabel.textContent = CONFIG.collectionPointId;
      renderPrefillDebug();

      setChip("neutral", "Ready");
      ui.statusLog.textContent = "";
      logStatus("Demo initialized.");
      logStatus("Config:", CONFIG);

      updateHeaderStatus("Manual mode ‚Äî open the Consent tab to trigger InstallCP.", "warn");

      // Watchdog: show whether SDK is visible
      window.setTimeout(() => {
        const hasSdk = Boolean(window.OneTrust || window.OtSdk);
        if (!hasSdk) {
          const msg = "OneTrust SDK not detected yet. Verify the integration script in <head> and that the Collection Point is published.";
          console.warn(msg);
          setChip("err", "SDK not detected");
          logStatus(msg);
          updateHeaderStatus("OneTrust SDK not detected ‚Äî check Integration Script / publish state.", "warn");
        } else {
          logStatus("OneTrust global detected (good).", { OneTrust: Boolean(window.OneTrust), OtSdk: Boolean(window.OtSdk) });
          setChip("ok", "SDK detected");
        }
      }, 1800);
    })();
  </script>
</body>
</html>
