<!-- Description: Single-file demo page that shows a simulated Iberia/Stripe-style checkout on top and embeds a OneTrust UCPM Embedded Web Form Collection Point underneath (auto/instant load, no prefills). -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Iberia-branded demo with simulated payment UI + OneTrust UCPM Embedded Web Form Collection Point (Embedded Web Form)." />
  <meta name="theme-color" content="#D71920" />
  <title>Iberia | Simulated Checkout + Consent (OneTrust UCPM)</title>

  <!-- OneTrust Embedded Web Form SDK integration script (from Collection Point → Integrations tab). Must be in <head>. -->
  <script
      src="https://privacyportaltrial.onetrust.com/consent-embedded-forms/consent-receipt-scripts/OtFormStub.js"
      data-id="0ceb7c0c-d27e-43c6-9c9c-877694285648"
      worker="https://consent-api.onetrust.com">
  </script>

  <style>
    :root{
      /* Iberia-inspired palette */
      --ib-red:#D71920;
      --ib-red-2:#B5141A;
      --ib-yellow:#FFC72C;
      --ink:#101828;
      --muted:#475467;
      --bg:#FFF7EB;
      --card:#FFFFFF;
      --line:#E4E7EC;
      --shadow: 0 18px 45px rgba(16,24,40,.10);
      --shadow-soft: 0 10px 30px rgba(16,24,40,.08);
      --radius: 18px;
      --radius-sm: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--ink);
      background:
        radial-gradient(1200px 500px at 10% 0%, rgba(255,199,44,.55) 0%, rgba(255,199,44,0) 65%),
        radial-gradient(1000px 600px at 90% 20%, rgba(215,25,32,.25) 0%, rgba(215,25,32,0) 70%),
        linear-gradient(180deg, #FFF2DE 0%, var(--bg) 40%, #FFFFFF 100%);
      overflow-x:hidden;
    }

    a{ color: var(--ib-red); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 28px 16px 34px;
    }

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 10px 4px 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }

    .logoMark{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background:
        conic-gradient(from 240deg, var(--ib-red), var(--ib-red), var(--ib-yellow), var(--ib-yellow), var(--ib-red));
      box-shadow: 0 10px 24px rgba(215,25,32,.25);
      position:relative;
      isolation:isolate;
    }
    .logoMark:after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: 10px;
      background: rgba(255,255,255,.18);
      transform: rotate(12deg);
      filter: blur(.2px);
      mix-blend-mode: overlay;
    }

    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brandText .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .16em;
      text-transform: uppercase;
    }
    .brandText .subtitle{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(228,231,236,.9);
      box-shadow: 0 8px 22px rgba(16,24,40,.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dot{
      width:9px;height:9px;border-radius:99px;
      background: var(--ib-red);
      box-shadow: 0 0 0 4px rgba(215,25,32,.15);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(228,231,236,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 18px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(228,231,236,.8);
      background:
        linear-gradient(180deg, rgba(255,255,255,.95) 0%, rgba(255,255,255,.85) 100%);
    }
    .cardTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .cardTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .cardTitle p{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    .cardBody{ padding: 18px; }

    /* Simulated Stripe-like payment UI */
    .checkoutRow{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 18px;
      align-items:start;
    }
    .checkoutLeft{ display:flex; flex-direction:column; gap:14px; }
    .checkoutRight{
      background: linear-gradient(180deg, rgba(16,24,40,.02) 0%, rgba(16,24,40,.00) 100%);
      border: 1px dashed rgba(71,84,103,.25);
      border-radius: var(--radius-sm);
      padding: 14px;
    }
    .orderLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(228,231,236,.8);
      font-size: 13px;
      color: var(--muted);
    }
    .orderLine:last-child{ border-bottom:none; }
    .orderLine strong{ color: var(--ink); }
    .amount{
      font-weight: 900;
      color: var(--ink);
      letter-spacing:.2px;
    }

    .stripeShell{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(228,231,236,.95);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      background: #fff;
    }
    .stripeTop{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:
        linear-gradient(135deg, rgba(215,25,32,.10) 0%, rgba(255,199,44,.18) 55%, rgba(255,255,255,1) 100%);
      border-bottom: 1px solid rgba(228,231,236,.9);
    }
    .stripeBadge{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 800;
      font-size: 12px;
      color: var(--ink);
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .stripeBadge .mini{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(135deg, #635BFF 0%, #4F46E5 65%, #1D4ED8 100%);
      position:relative;
      box-shadow: 0 12px 24px rgba(79,70,229,.25);
    }
    .stripeBadge .mini:after{
      content:"";
      position:absolute;
      inset:7px;
      border-radius:7px;
      background: rgba(255,255,255,.18);
      transform: rotate(8deg);
      mix-blend-mode: overlay;
    }
    .secureHint{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .lock{
      width: 16px; height:16px;
      display:inline-block;
      background: conic-gradient(from 120deg, rgba(16,24,40,.18), rgba(16,24,40,.45), rgba(16,24,40,.18));
      -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-7-2a2 2 0 0 1 4 0v2h-4V6Zm7 14H7V10h10v10Z"/></svg>') center/contain no-repeat;
      mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-7-2a2 2 0 0 1 4 0v2h-4V6Zm7 14H7V10h10v10Z"/></svg>') center/contain no-repeat;
    }

    .stripeForm{
      padding: 14px;
      display:grid;
      gap: 12px;
    }
    .fieldGrid{
      display:grid;
      grid-template-columns: 1fr 140px 120px;
      gap: 10px;
    }
    .labelRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 4px;
    }
    label{
      font-size: 12px;
      font-weight: 700;
      color: var(--ink);
      letter-spacing:.2px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(228,231,236,.95);
      outline:none;
      font-size: 14px;
      background: #fff;
      transition: border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    input:focus{
      border-color: rgba(99,91,255,.55);
      box-shadow: 0 0 0 4px rgba(99,91,255,.14);
    }
    input::placeholder{ color: rgba(71,84,103,.55); }

    .payRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-top: 2px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      letter-spacing:.2px;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, var(--ib-red) 0%, #F04438 45%, var(--ib-yellow) 110%);
      color:#fff;
      box-shadow: 0 16px 34px rgba(215,25,32,.22);
    }
    .btnPrimary:hover{ box-shadow: 0 18px 40px rgba(215,25,32,.28); }
    .btnGhost{
      background: rgba(16,24,40,.04);
      color: var(--ink);
    }
    .btnGhost:hover{ background: rgba(16,24,40,.06); }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    .msg{
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 12px;
      border: 1px solid rgba(228,231,236,.95);
      background: rgba(16,24,40,.02);
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .msg strong{ color: var(--ink); }
    .msg.ok{
      border-color: rgba(5,150,105,.25);
      background: rgba(5,150,105,.08);
      color: #065F46;
    }
    .msg.err{
      border-color: rgba(240,68,56,.28);
      background: rgba(240,68,56,.08);
      color: #7A271A;
    }
    .icon{
      width:18px;height:18px;border-radius: 6px;
      background: rgba(71,84,103,.12);
      flex: 0 0 auto;
      position:relative;
    }
    .icon:after{
      content:"";
      position:absolute;
      inset:4px;
      border-radius:5px;
      background: rgba(71,84,103,.24);
    }
    .icon.ok{ background: rgba(5,150,105,.18); }
    .icon.ok:after{ background: rgba(5,150,105,.45); }
    .icon.err{ background: rgba(240,68,56,.18); }
    .icon.err:after{ background: rgba(240,68,56,.45); }

    /* OneTrust container styling: keep it clean; avoid assuming OT internal selectors */
    .otShell{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(228,231,236,.95);
      background: #fff;
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .otTop{
      padding: 14px;
      border-bottom: 1px solid rgba(228,231,236,.9);
      background:
        linear-gradient(135deg, rgba(255,199,44,.22) 0%, rgba(255,255,255,1) 55%, rgba(215,25,32,.08) 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .otTop .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .otTop .left .kicker{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--ib-red-2);
    }
    .otTop .left .desc{
      font-size: 12px;
      color: var(--muted);
    }

    /* Debug / Status */
    .statusGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .statusBox{
      border-radius: 14px;
      border: 1px solid rgba(228,231,236,.95);
      background: rgba(255,255,255,.8);
      padding: 12px;
    }
    .statusHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .statusHead .label{
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .statusHead .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(228,231,236,.95);
      background: rgba(16,24,40,.02);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .chip .tinyDot{
      width:8px;height:8px;border-radius:99px;background: rgba(71,84,103,.55);
    }
    .chip.ok .tinyDot{ background: rgba(5,150,105,.85); }
    .chip.err .tinyDot{ background: rgba(240,68,56,.9); }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(16,24,40,.78);
      line-height: 1.45;
      word-break: break-word;
      white-space: pre-wrap;
    }

    footer{
      margin-top: 20px;
      padding: 18px 0 10px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
    }

    /* Mobile / responsive */
    @media (max-width: 920px){
      .checkoutRow{ grid-template-columns: 1fr; }
      .fieldGrid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; align-items:flex-start; }
      .pill{ align-self:flex-start; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; scroll-behavior:auto !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand" aria-label="Iberia demo header">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="brandText">
          <div class="title">IBERIA</div>
          <div class="subtitle">Checkout + Consent demo · Load Method: <strong id="loadMethodLabel">Instant</strong></div>
        </div>
      </div>
      <div class="pill" role="status" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span id="headerStatusText">Ready — waiting for OneTrust form events…</span>
      </div>
    </header>

    <main class="grid" aria-label="Main content">
      <!-- PAYMENT (Simulated Stripe gateway) -->
      <section class="card" aria-label="Simulated payment section">
        <div class="cardHeader">
          <div class="cardTitle">
            <h2>1) Payment (simulated)</h2>
            <p>Stripe-like UI for demo purposes only — no real payment processing.</p>
          </div>
          <div class="pill" aria-label="Simulation mode pill">
            <span class="dot" style="background:#635BFF; box-shadow: 0 0 0 4px rgba(99,91,255,.14)" aria-hidden="true"></span>
            Simulation Mode
          </div>
        </div>

        <div class="cardBody">
          <div class="checkoutRow">
            <div class="checkoutLeft">
              <div class="stripeShell" aria-label="Simulated Stripe card form">
                <div class="stripeTop">
                  <div class="stripeBadge">
                    <span class="mini" aria-hidden="true"></span>
                    <span>Card payment</span>
                  </div>
                  <div class="secureHint">
                    <span class="lock" aria-hidden="true"></span>
                    <span>Secure checkout (simulated)</span>
                  </div>
                </div>

                <form class="stripeForm" id="fakePaymentForm" autocomplete="off" novalidate>
                  <div>
                    <div class="labelRow">
                      <label for="cardholder">Cardholder name</label>
                      <span class="hint">As printed on card</span>
                    </div>
                    <input id="cardholder" name="cardholder" type="text" inputmode="text" placeholder="e.g., Alvaro Barroso" autocomplete="off" />
                  </div>

                  <div>
                    <div class="labelRow">
                      <label for="cardnumber">Card number</label>
                      <span class="hint">Demo accepts test numbers</span>
                    </div>
                    <input id="cardnumber" name="cardnumber" type="text" inputmode="numeric" placeholder="4242 4242 4242 4242" autocomplete="off" maxlength="19" />
                  </div>

                  <div class="fieldGrid">
                    <div>
                      <div class="labelRow">
                        <label for="email">Email receipt</label>
                        <span class="hint">Optional</span>
                      </div>
                      <input id="email" name="email" type="email" inputmode="email" placeholder="name@domain.com" autocomplete="off" />
                    </div>
                    <div>
                      <div class="labelRow">
                        <label for="exp">Expiry</label>
                        <span class="hint">MM/YY</span>
                      </div>
                      <input id="exp" name="exp" type="text" inputmode="numeric" placeholder="12/34" autocomplete="off" maxlength="5" />
                    </div>
                    <div>
                      <div class="labelRow">
                        <label for="cvc">CVC</label>
                        <span class="hint">3–4 digits</span>
                      </div>
                      <input id="cvc" name="cvc" type="password" inputmode="numeric" placeholder="123" autocomplete="off" maxlength="4" />
                    </div>
                  </div>

                  <div class="payRow">
                    <button class="btn btnGhost" type="button" id="resetPaymentBtn" aria-label="Reset payment form">Reset</button>
                    <button class="btn btnPrimary" type="submit" id="payBtn" aria-label="Simulate payment">
                      <span aria-hidden="true">✈️</span>
                      <span>Pay €199.00</span>
                    </button>
                  </div>

                  <div id="paymentMsg" class="msg" role="status" aria-live="polite">
                    <span class="icon" aria-hidden="true"></span>
                    <div>
                      <strong>Demo tip:</strong> Use <span class="mono">4242 4242 4242 4242</span>, any future <span class="mono">MM/YY</span>, any 3–4 digit <span class="mono">CVC</span>.
                      <div class="hint" style="margin-top:4px;">Nothing is stored; this only simulates success/failure states.</div>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <aside class="checkoutRight" aria-label="Order summary">
              <div class="orderLine">
                <span>Flight</span>
                <strong>MAD → BCN</strong>
              </div>
              <div class="orderLine">
                <span>Fare</span>
                <span class="amount">€179.00</span>
              </div>
              <div class="orderLine">
                <span>Taxes</span>
                <span class="amount">€20.00</span>
              </div>
              <div class="orderLine">
                <span><strong>Total</strong></span>
                <span class="amount">€199.00</span>
              </div>
              <div class="hint" style="margin-top:10px;">
                Next step: review and submit the consent form below. (Form loads automatically — Instant.)
              </div>
            </aside>
          </div>
        </div>
      </section>

      <!-- CONSENT (OneTrust Embedded Web Form) -->
      <section class="card" aria-label="OneTrust consent section">
        <div class="cardHeader">
          <div class="cardTitle">
            <h2>2) Consent &amp; Preferences</h2>
            <p>Embedded OneTrust UCPM Web Form Collection Point rendered below.</p>
          </div>
          <div class="pill" aria-label="OneTrust events pill">
            <span class="dot" style="background:var(--ib-yellow); box-shadow: 0 0 0 4px rgba(255,199,44,.22)" aria-hidden="true"></span>
            Listening for <span class="mono" style="font-size:11px;">OnetrustFormLoaded</span> &amp; <span class="mono" style="font-size:11px;">OneTrustWebFormSubmitted</span>
          </div>
        </div>

        <div class="cardBody">
          <div class="otShell" aria-label="OneTrust form container shell">
            <div class="otTop">
              <div class="left">
                <div class="kicker">OneTrust Embedded Web Form</div>
                <div class="desc">Container: <span class="mono">#ot-container</span> · Collection Point ID: <span class="mono" id="cpLabel"></span></div>
              </div>
              <div class="secureHint" title="Consent capture is handled by OneTrust">
                <span class="lock" aria-hidden="true"></span>
                <span>Consent capture</span>
              </div>
            </div>

            <!-- TARGET_CONTAINER_ID: required DOM element where the OneTrust web form should render -->
            <div id="ot-container" aria-label="OneTrust web form container" style="padding:14px;"></div>
          </div>

          <!-- Debug / Status section -->
          <div class="statusGrid" aria-label="Debug and status">
            <div class="statusBox">
              <div class="statusHead">
                <div class="label">Debug / Status</div>
                <div class="chip" id="statusChip">
                  <span class="tinyDot" aria-hidden="true"></span>
                  <span id="statusChipText">Initializing</span>
                </div>
              </div>
              <div class="mono" id="statusLog">Booting…</div>
            </div>

            <div class="statusBox">
              <div class="statusHead">
                <div class="label">Prefill (query parameter) helper</div>
                <div class="chip" id="prefillChip">
                  <span class="tinyDot" aria-hidden="true"></span>
                  <span id="prefillChipText">Prefill mode: None</span>
                </div>
              </div>
              <div class="mono" id="prefillLog">
Prefill is disabled for this demo.
If you ever enable prefilling, OneTrust supports passing query parameters where each key matches the “Form Field Label” configured in OneTrust.
Example: ?Email=name%40domain.com&amp;Country=Spain
Note: values must be URL-encoded (e.g. “+” → “%2B”) and fields separated by “&amp;”.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>Created by Alvaro Barroso in Madrid, Españita.</footer>
  </div>

  <script>
    "use strict";

    /**
     * Single configuration object (required).
     * Instant: do not call InstallCP manually (assume it appears on page load).
     * Manual: call InstallCP when desired.
     */
    const CONFIG = {
      collectionPointId: "c9322d35-cb63-4974-b65a-5d415f818a05",
      loadMethod: "Instant",              // "Instant" | "Manual"
      containerId: "ot-container",        // TARGET_CONTAINER_ID
      optionalRedirectUrl: "",            // none
      prefillMode: "None"                 // "None" | "QueryParameters"
    };

    // ---------- UI helpers ----------
    const el = (id) => document.getElementById(id);

    const ui = {
      headerStatusText: el("headerStatusText"),
      loadMethodLabel: el("loadMethodLabel"),
      cpLabel: el("cpLabel"),
      statusChip: el("statusChip"),
      statusChipText: el("statusChipText"),
      statusLog: el("statusLog"),
      prefillChip: el("prefillChip"),
      prefillChipText: el("prefillChipText"),
      prefillLog: el("prefillLog")
    };

    function safeStringify(obj) {
      try {
        return JSON.stringify(obj, (k, v) => (typeof v === "bigint" ? v.toString() : v), 2);
      } catch (e) {
        return String(obj);
      }
    }

    function setChip(state /* ok|err|neutral */, text) {
      const chip = ui.statusChip;
      chip.classList.remove("ok", "err");
      if (state === "ok") chip.classList.add("ok");
      if (state === "err") chip.classList.add("err");
      ui.statusChipText.textContent = text;
    }

    function logStatus(message, data) {
      const stamp = new Date().toLocaleTimeString();
      const line = `[${stamp}] ${message}`;
      const payload = (data !== undefined) ? `\n${safeStringify(data)}` : "";
      ui.statusLog.textContent = (ui.statusLog.textContent ? (ui.statusLog.textContent + "\n") : "") + line + payload;
      const lines = ui.statusLog.textContent.split("\n");
      if (lines.length > 140) ui.statusLog.textContent = lines.slice(lines.length - 140).join("\n");
    }

    function updateHeaderStatus(text, tone /* ok|warn|neutral */) {
      ui.headerStatusText.textContent = text;
      const dot = document.querySelector("header .pill .dot");
      if (!dot) return;
      if (tone === "ok") {
        dot.style.background = "rgba(5,150,105,.95)";
        dot.style.boxShadow = "0 0 0 4px rgba(5,150,105,.18)";
      } else if (tone === "warn") {
        dot.style.background = "rgba(255,199,44,.95)";
        dot.style.boxShadow = "0 0 0 4px rgba(255,199,44,.22)";
      } else {
        dot.style.background = "var(--ib-red)";
        dot.style.boxShadow = "0 0 0 4px rgba(215,25,32,.15)";
      }
    }

    // ---------- OneTrust load control (Manual only) ----------
    let installAttempted = false;

    function canUseOneTrustInstall() {
      return Boolean(window.OneTrust && window.OneTrust.webform && typeof window.OneTrust.webform.InstallCP === "function");
    }

    function installCollectionPointManual(triggerSource) {
      if (CONFIG.loadMethod !== "Manual") return;
      if (installAttempted) {
        logStatus(`InstallCP skipped (already attempted). Trigger: ${triggerSource}`);
        return;
      }
      installAttempted = true;

      if (!canUseOneTrustInstall()) {
        const msg = "OneTrust SDK not available yet — cannot call InstallCP. Check integration script in <head>.";
        console.error(msg);
        setChip("err", "SDK missing");
        logStatus(msg);
        updateHeaderStatus("OneTrust SDK not detected — cannot force-load (Manual).", "warn");
        return;
      }

      try {
        setChip("neutral", "Installing…");
        logStatus(`Calling OneTrust.webform.InstallCP(\"${CONFIG.collectionPointId}\") (Manual).`);
        window.OneTrust.webform.InstallCP(CONFIG.collectionPointId, function (result) {
          console.log("InstallCP callback result:", result);
          logStatus("InstallCP callback returned:", result);
          setChip(result ? "ok" : "err", result ? "InstallCP ok" : "InstallCP failed");
        });
      } catch (e) {
        console.error("InstallCP error:", e);
        setChip("err", "InstallCP error");
        logStatus("InstallCP threw an error:", { message: e.message, stack: e.stack });
      }
    }

    // ---------- Required Events ----------
    window.addEventListener("OnetrustFormLoaded", (event) => {
      console.log("OnetrustFormLoaded event triggered", event.detail);
      setChip("ok", "Form loaded");
      updateHeaderStatus("OneTrust form loaded successfully.", "ok");
      logStatus("OnetrustFormLoaded received. Details:", event.detail);
    });

    window.addEventListener("OneTrustWebFormSubmitted", (event) => {
      console.log("OneTrustWebFormSubmitted event triggered", event.detail);
      setChip("ok", "Form submitted");
      updateHeaderStatus("Consent form submitted (payload logged to console).", "ok");
      logStatus("OneTrustWebFormSubmitted received. Consent receipt payload (event.detail):", event.detail);
      showConsentSuccess();
    });

    function showConsentSuccess() {
      const stamp = new Date().toLocaleString();
      logStatus(`✅ Consent submission acknowledged locally at ${stamp}. (No redirect configured)`);
    }

    // ---------- Prefill helper (query params) ----------
    function readQueryParameters() {
      const params = new URLSearchParams(window.location.search);
      const entries = [];
      for (const [k, v] of params.entries()) entries.push([k, v]);
      return entries;
    }

    function renderPrefillDebug() {
      ui.prefillChipText.textContent = `Prefill mode: ${CONFIG.prefillMode}`;
      ui.prefillChip.classList.remove("ok", "err");

      if (CONFIG.prefillMode !== "QueryParameters") {
        ui.prefillChip.classList.add("ok");
        ui.prefillLog.textContent =
`Prefill is disabled for this demo.
If you ever enable prefilling, OneTrust supports passing query parameters where each key matches the “Form Field Label” configured in OneTrust.
Example: ?Email=name%40domain.com&Country=Spain
Note: values must be URL-encoded (e.g. “+” → “%2B”) and fields separated by “&”.`;
        return;
      }

      const qp = readQueryParameters();
      if (!qp.length) {
        ui.prefillChip.classList.add("err");
        ui.prefillLog.textContent =
`Prefill mode is enabled, but no query parameters were found.
Add parameters using OneTrust “Form Field Label” keys, e.g.:
?Email=name%40domain.com&Country=Spain`;
        return;
      }

      ui.prefillChip.classList.add("ok");
      ui.prefillLog.textContent =
`Query parameters detected (these would be used by OneTrust prefilling if enabled/configured):\n\n` +
qp.map(([k, v]) => `- ${k} = ${v}`).join("\n") +
`\n\nReminder: values must be URL-encoded (e.g. “+” → “%2B”) and multiple fields are separated by “&”.`;
    }

    // ---------- Simulated Stripe behaviors ----------
    const payment = {
      form: el("fakePaymentForm"),
      cardholder: el("cardholder"),
      cardnumber: el("cardnumber"),
      email: el("email"),
      exp: el("exp"),
      cvc: el("cvc"),
      resetBtn: el("resetPaymentBtn"),
      msg: el("paymentMsg")
    };

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;",
        "'":"&#39;"
      }[c]));
    }

    function setPaymentMessage(type /* ok|err|neutral */, title, body) {
      payment.msg.classList.remove("ok", "err");
      const icon = payment.msg.querySelector(".icon");
      icon.classList.remove("ok", "err");
      if (type === "ok") { payment.msg.classList.add("ok"); icon.classList.add("ok"); }
      if (type === "err") { payment.msg.classList.add("err"); icon.classList.add("err"); }

      payment.msg.querySelector("div").innerHTML =
        `<strong>${escapeHtml(title)}</strong><div class="hint" style="margin-top:4px;">${escapeHtml(body)}</div>`;
    }

    function normalizeCardNumber(value) {
      return value.replace(/\D/g, "").slice(0, 19);
    }

    function formatCardNumber(value) {
      const digits = normalizeCardNumber(value);
      return digits.replace(/(.{4})/g, "$1 ").trim();
    }

    function luhnCheck(numStr) {
      const digits = numStr.replace(/\s+/g, "");
      if (!digits || digits.length < 12) return false;
      let sum = 0, alt = false;
      for (let i = digits.length - 1; i >= 0; i--) {
        let n = parseInt(digits[i], 10);
        if (Number.isNaN(n)) return false;
        if (alt) {
          n *= 2;
          if (n > 9) n -= 9;
        }
        sum += n;
        alt = !alt;
      }
      return sum % 10 === 0;
    }

    function normalizeExp(value) {
      const digits = value.replace(/\D/g, "").slice(0, 4);
      if (digits.length <= 2) return digits;
      return digits.slice(0,2) + "/" + digits.slice(2,4);
    }

    function validExp(mmYY) {
      const m = mmYY.match(/^(\d{2})\/(\d{2})$/);
      if (!m) return false;
      const mm = parseInt(m[1], 10);
      const yy = parseInt(m[2], 10);
      if (mm < 1 || mm > 12) return false;
      return yy >= 0 && yy <= 99;
    }

    function validCvc(v) {
      return /^\d{3,4}$/.test(v);
    }

    function simulatePayment() {
      const number = payment.cardnumber.value.trim();
      const exp = payment.exp.value.trim();
      const cvc = payment.cvc.value.trim();

      if (!luhnCheck(number)) {
        setPaymentMessage("err", "Payment failed", "Card number did not pass validation (Luhn). Try 4242 4242 4242 4242.");
        return false;
      }
      if (!validExp(exp)) {
        setPaymentMessage("err", "Payment failed", "Expiry must be in MM/YY format and a valid month.");
        return false;
      }
      if (!validCvc(cvc)) {
        setPaymentMessage("err", "Payment failed", "CVC must be 3–4 digits.");
        return false;
      }

      setPaymentMessage("ok", "Payment authorized (simulated)", "Success! Now complete the consent form below.");
      return true;
    }

    // Input formatting hooks
    payment.cardnumber.addEventListener("input", (e) => {
      e.target.value = formatCardNumber(e.target.value);
    });

    payment.exp.addEventListener("input", (e) => {
      e.target.value = normalizeExp(e.target.value);
    });

    payment.cvc.addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D/g, "").slice(0, 4);
    });

    payment.resetBtn.addEventListener("click", () => {
      payment.form.reset();
      setPaymentMessage("neutral", "Demo tip:", "Use 4242 4242 4242 4242, any future MM/YY, any 3–4 digit CVC.");
    });

    payment.form.addEventListener("submit", (e) => {
      e.preventDefault();
      // Prevents browser default GET submission (and URL query params)
      simulatePayment();
    });

    // ---------- Boot ----------
    (function boot() {
      ui.loadMethodLabel.textContent = CONFIG.loadMethod;
      ui.cpLabel.textContent = CONFIG.collectionPointId;

      setChip("neutral", "Waiting…");
      ui.statusLog.textContent = "";
      logStatus("Demo initialized.");
      logStatus("Config:", CONFIG);

      renderPrefillDebug();

      const container = document.getElementById(CONFIG.containerId);
      if (!container) {
        const msg = `TARGET_CONTAINER_ID not found in DOM: #${CONFIG.containerId}`;
        console.error(msg);
        setChip("err", "Container missing");
        logStatus(msg);
        updateHeaderStatus("Container missing — form cannot render.", "warn");
        return;
      }

      if (CONFIG.loadMethod === "Instant") {
        // Do NOT call InstallCP manually.
        updateHeaderStatus("Instant load configured — waiting for OneTrust to render the form…", "warn");
        logStatus("Load method is Instant — not calling InstallCP.");
      } else {
        updateHeaderStatus("Manual load configured — attempting InstallCP…", "warn");
        installCollectionPointManual("auto on page load");
      }

      // Watchdog: if OneTrust isn't detected after a short delay, show a helpful status.
      window.setTimeout(() => {
        const hasSdk = Boolean(window.OneTrust || window.OtSdk);
        if (!hasSdk) {
          const msg = "OneTrust SDK not detected yet. Verify the integration script in <head> and that the Collection Point is published.";
          console.warn(msg);
          setChip("err", "SDK not detected");
          logStatus(msg);
          updateHeaderStatus("OneTrust SDK not detected — check Integration Script / publish state.", "warn");
        } else {
          logStatus("OneTrust global detected (good). Waiting for OnetrustFormLoaded…", {
            OneTrust: Boolean(window.OneTrust),
            OtSdk: Boolean(window.OtSdk)
          });
        }
      }, 1800);
    })();
  </script>
</body>
</html>
